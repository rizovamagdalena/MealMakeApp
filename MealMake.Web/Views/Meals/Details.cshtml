@model MealMake.Domain.ViewModels.MealViewModel

@{
    ViewData["Title"] = Model.Name;
    Guid? collectionId = ViewBag.CollectionId as Guid?;
}

<div class="container my-5">

    @if (collectionId != null)
    {
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="alert alert-info mb-0 flex-grow-1">
                Adding to collection: <strong>@ViewBag.CollectionName</strong>
            </div>
            <div class="d-flex gap-2">
                <a asp-controller="MealCollections" asp-action="Details" asp-route-id="@collectionId"
                   class="btn btn-outline-secondary btn-sm">
                    Back to Collection
                </a>
            </div>
        </div>
    }

    <div class="row g-4">
        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <img src="@Model.Thumbnail" class="card-img-top rounded-top" style="height: 300px; object-fit: cover;" alt="@Model.Name" />
                <div class="card-body text-center">
                    <h4 class="card-title fw-bold">@Model.Name</h4>
                    <p class="card-text mb-1"><strong>Category:</strong> @Model.Category</p>
                    <p class="card-text mb-1"><strong>Area:</strong> @Model.Area</p>

                    <form id="favoriteForm" method="post" data-meal-id="@Model.Id">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="mealId" value="@Model.Id" />
                        <input type="hidden" name="mealName" value="@Model.Name" />
                        <input type="hidden" name="mealThumbnail" value="@Model.Thumbnail" />
                        <button type="button" id="favoriteBtn"
                                class="btn w-100 @(Model.IsFavorite ? "btn-primary" : "btn-light") mt-2">
                            @(Model.IsFavorite ? "💙 Remove from Favorites" : "🤍 Add to Favorites")
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow-sm border-0 p-3">
                <h4 class="mb-3">Ingredients</h4>
                <div class="row row-cols-2 row-cols-md-3 g-2 mb-4">
                    @foreach (var ing in Model.Ingredients)
                    {
                        <div class="col">
                            <div class="border rounded p-2 bg-light text-center">
                                <strong>@ing.Name</strong><br />
                                <span class="text-muted">@ing.Measure</span>
                            </div>
                        </div>
                    }
                </div>

                <h4 class="mb-3">Instructions</h4>
                <p style="white-space: pre-line;">@Model.Instructions</p>

                @if (!string.IsNullOrEmpty(Model.YoutubeUrl))
                {
                    <a href="@Model.YoutubeUrl" target="_blank" class="btn btn-danger mt-3">
                        <i class="bi bi-play-circle-fill"></i> Watch on YouTube
                    </a>
                }
            </div>

            @if (collectionId != null)
            {
                <div class="mt-3">
                    @if (!Model.IsInCollection)
                    {
                        <form class="add-to-collection-form"
                              data-collection-id="@collectionId"
                              data-meal-id="@Model.Id"
                              method="post">
                            <button type="button" class="btn btn-success w-100">
                                ➕ Add to Collection
                            </button>
                        </form>
                    }
                    else
                    {
                        <form class="add-to-collection-form"
                              data-collection-id="@collectionId"
                              data-meal-id="@Model.Id"
                              data-action="remove"
                              method="post">
                            <button type="button" class="btn btn-danger w-100">
                                ❌ Remove from Collection
                            </button>
                        </form>
                    }
                </div>
            }
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Favorite toggle
        $('#favoriteBtn').click(function() {
            var form = $('#favoriteForm');
            var data = form.serialize();

            $.post('@Url.Action("ToggleFavorite", "Meals")', data)
                .done(function() {
                    var btn = $('#favoriteBtn');
                    if (btn.hasClass('btn-light')) {
                        btn.removeClass('btn-light').addClass('btn-primary').text('💙 Remove from Favorites');
                    } else {
                        btn.removeClass('btn-primary').addClass('btn-light').text('🤍 Add to Favorites');
                    }
                })
                .fail(function() { alert('Something went wrong. Please try again.'); });
        });

        $(document).on('click', '.add-to-collection-form button', function() {
            var form = $(this).closest('form');
            var btn = $(this);
            var action = form.attr('data-action') || 'add';
            var collectionId = form.data('collection-id');
            var mealId = form.data('meal-id');

            if(action === 'add'){
                $.post('/MealCollections/AddMealToCollection', { collectionId: collectionId, mealId: mealId })
                .done(function(response){
                    btn.removeClass('btn-success').addClass('btn-danger').text('❌ Remove from Collection');
                    form.attr('data-action','remove');
                    if(response.collectionMealId) form.attr('data-collection-meal-id', response.collectionMealId);
                }).fail(function(){ alert('Failed to add meal!'); });
            } else {
                $.post('/MealCollections/RemoveMealFromCollection', { collectionId: collectionId, mealId: mealId })
                .done(function(){
                    btn.removeClass('btn-danger').addClass('btn-success').text('➕ Add to Collection');
                    form.attr('data-action','add');
                }).fail(function(){ alert('Failed to remove meal!'); });
            }
        });
    });
</script>
